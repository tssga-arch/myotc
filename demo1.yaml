#
# Create a jumpserver environment
#
sid: demo1
snat: True
sgs:
  common:
   - 22/tcp
   - 443/tcp
   - 80/tcp
nets:
  1:
    #~ cidr: "10.1.1.0/24"
    #~ dns_servers:
     #~ - 8.8.8.8
     #~ - 8.8.4.4
    vms:
      3:
        image: Standard_Ubuntu_20.04_latest
        flavor: s3.large.2
        eip: True
        sg: common
        vols:
          1: {{ size: 2 }}
          2: {{ size: 4 }}
          volume-8d36: {{ }}
        user_data:
          # Do apt-get update
          package_update: True
          package_reboot_if_required: true
          packages:
           - pwgen
           - micro
           - python3-venv
           - zip

           - xfce4
           - xfce4-goodies
           - xubuntu-icon-theme
           - gnome-icon-theme
           - tango-icon-theme

           - firefox
           - geany
           - tigervnc-viewer

           - libvte9
           - doc-base
           - devhelp
           - libnotify-bin
           - yelp

           - xorg
           - xserver-xorg-legacy
           - xserver-xorg-video-all
           - mesa-utils
           - xfonts-base
           - xfonts-100dpi
           - xfonts-75dpi
           - xfonts-scalable
           - x11-xserver-utils
           - xbitmaps
           - xclip
           - tigervnc-standalone-server
           - tigervnc-common

           - tigervnc-xorg-extension
           - slim

          users:
            - name: linux
              sudo: ["ALL=(ALL) NOPASSWD:ALL"]
              groups: users
              lock_passwd: false
              shell: /bin/bash
              passwd: $6$a9mFVaQzLjBr5GEz$O3dodR3VudX2b5aGM99pPA5J/MCSp0y9n8dmjK7iJmkmAsBptrF3R0lbKKpU0HPYuOLDc7Yrd7q/6LVnjiy25.
              ssh_authorized_keys:
              - #include --raw ssh/id_rsa.pub

          write_files:
           - owner: root:root
             path: /etc/X11/xorg.conf
             permissions: '0644'
             content: |
              Section "Module"
               Load "vnc"
              EndSection
              Section "Screen"
               Identifier "Screen0"
               Option "UserPasswdVerifier" "VncAuth"
               Option "PasswordFile" "/root/.vncpasswd"
              EndSection
           - owner: root:root
             path: /root/.vncpasswd
             permissions: '0644'
             encoding: b64
             content: 4QWapb8ruN0=

          runcmd:
           # Let sshd listen on port 443 too.
           - "echo Port 22 >> /etc/ssh/sshd_config"
           - "echo Port 443 >> /etc/ssh/sshd_config"
           - "sed -i~ -e 's/^.*AllowTcpForwarding.*/AllowTcpForwarding yes/' /etc/ssh/sshd_config"
           - systemctl restart sshd
           - service slim start


